name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix for dev release (e.g., -dev.1, -alpha.0, -beta.1). Leave empty for stable release.'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (no publish)'
        required: false
        type: boolean
        default: false

env:
  EMSDK_VERSION: '4.0.22'
  NODE_VERSION: '22'

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      npm_tag: ${{ steps.version.outputs.npm_tag }}
      suffix: ${{ steps.version.outputs.suffix }}
      dry_run: ${{ steps.version.outputs.dry_run }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Determine version and npm tag
        id: version
        run: |
          MAKEFILE_VERSION=$(grep '^DUCKDB_VERSION' Makefile | sed 's/.*:= *v//')

          if [ "${{ github.event_name }}" = "push" ]; then
            TAG_VERSION="${GITHUB_REF#refs/tags/v}"
            if [ "$TAG_VERSION" != "$MAKEFILE_VERSION" ]; then
              echo "::error::Tag version ($TAG_VERSION) doesn't match DUCKDB_VERSION in Makefile ($MAKEFILE_VERSION)"
              echo "::error::Update DUCKDB_VERSION in Makefile to v$TAG_VERSION before tagging"
              exit 1
            fi
            VERSION="$TAG_VERSION"
            SUFFIX=""
          else
            VERSION="$MAKEFILE_VERSION"
            if [ -n "${{ github.event.inputs.version_suffix }}" ]; then
              SUFFIX="${{ github.event.inputs.version_suffix }}"
              VERSION="${VERSION}${SUFFIX}"
            else
              SUFFIX=$(grep '^VERSION_SUFFIX' Makefile | sed 's/.*:= *//')
              VERSION="${VERSION}${SUFFIX}"
            fi
          fi

          if [[ "$VERSION" == *"-dev"* ]] || [[ "$VERSION" == *"-alpha"* ]] || [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-rc"* ]]; then
            NPM_TAG="dev"
          else
            NPM_TAG="latest"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "npm_tag=$NPM_TAG" >> $GITHUB_OUTPUT
          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
          echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT

          echo "Release version: $VERSION (npm tag: $NPM_TAG)"

  build-wasm:
    runs-on: ubuntu-latest
    needs: version
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Emscripten SDK
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{ env.EMSDK_VERSION }}
          actions-cache-folder: 'emsdk-cache'

      - name: Verify
        run: emcc -v

      - name: Cache DuckDB build
        uses: actions/cache@v5
        with:
          path: build/emscripten
          key: duckdb-wasm-release-${{ runner.os }}-${{ env.EMSDK_VERSION }}-${{ hashFiles('scripts/build-duckdb.sh', 'Makefile', 'patches/**') }}
          restore-keys: |
            duckdb-wasm-release-${{ runner.os }}-${{ env.EMSDK_VERSION }}-
            duckdb-wasm-${{ runner.os }}-${{ env.EMSDK_VERSION }}-

      - name: Install binaryen
        run: sudo apt-get install -y binaryen

      - name: Clean stale CMake cache
        run: |
          rm -rf build/emscripten/CMakeCache.txt build/emscripten/CMakeFiles
          # Ensure extensions rebuild to avoid stale archives when cache is reused
          rm -rf build/emscripten/extension

      - name: Build browser WASM
        run: make duckdb-browser

      - name: Build workers WASM
        run: make duckdb-workers

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-wasm-dist
          path: |
            dist/duckdb.wasm
            dist/duckdb-workers.wasm
            dist/duckdb.js
            dist/duckdb-workers.js
          if-no-files-found: error

  browser:
    runs-on: ubuntu-latest
    needs: [version, build-wasm]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: duckdb-wasm-dist
          path: dist

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Sync package versions
        run: make sync-versions VERSION_SUFFIX="${{ needs.version.outputs.suffix }}"

      - name: Install dependencies
        run: |
          cd packages/ducklings-browser && pnpm install --no-frozen-lockfile

      - name: Build
        run: |
          cd packages/ducklings-browser
          pnpm build

      - name: Type check
        run: |
          cd packages/ducklings-browser && pnpm typecheck

      - name: Test
        run: |
          cd packages/ducklings-browser && pnpm test

      - name: Publish @ducklings/browser
        if: ${{ needs.version.outputs.dry_run != 'true' }}
        run: |
          cd packages/ducklings-browser
          npm publish --access public --tag ${{ needs.version.outputs.npm_tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  workers:
    runs-on: ubuntu-latest
    needs: [version, build-wasm]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: duckdb-wasm-dist
          path: dist

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Sync package versions
        run: make sync-versions VERSION_SUFFIX="${{ needs.version.outputs.suffix }}"

      - name: Install dependencies
        run: |
          cd packages/ducklings-workers && pnpm install --no-frozen-lockfile

      - name: Build
        run: |
          cd packages/ducklings-workers
          pnpm build

      - name: Type check
        run: |
          cd packages/ducklings-workers && pnpm typecheck

      - name: Test
        run: |
          cd packages/ducklings-workers && pnpm test

      - name: Publish @ducklings/workers
        if: ${{ needs.version.outputs.dry_run != 'true' }}
        run: |
          cd packages/ducklings-workers
          npm publish --access public --tag ${{ needs.version.outputs.npm_tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: [version, build-wasm, browser, workers]
    if: ${{ github.event_name == 'push' && needs.version.outputs.dry_run != 'true' }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: duckdb-wasm-dist
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/duckdb.wasm
            dist/duckdb-workers.wasm
          prerelease: ${{ needs.version.outputs.npm_tag == 'dev' }}
          body: |
            ## Ducklings v${{ needs.version.outputs.version }}

            ### Packages
            - [`@ducklings/browser`](https://www.npmjs.com/package/@ducklings/browser) - Browser version
            - [`@ducklings/workers`](https://www.npmjs.com/package/@ducklings/workers) - Cloudflare Workers version

            ### Installation
            ```bash
            # Browser
            npm install @ducklings/browser@${{ needs.version.outputs.version }}

            # Cloudflare Workers
            npm install @ducklings/workers@${{ needs.version.outputs.version }}
            ```

            ### Usage

            **Browser:**
            ```typescript
            import { init, DuckDB } from '@ducklings/browser';

            await init();
            const db = new DuckDB();
            const conn = db.connect();
            const result = conn.query('SELECT 42 as answer');
            ```

            **Cloudflare Workers:**
            ```typescript
            import { init, DuckDB } from '@ducklings/workers';
            import wasmModule from '@ducklings/workers/wasm';

            await init({ wasmModule });
            const db = new DuckDB();
            const conn = db.connect();
            const result = await conn.query('SELECT 42 as answer');
            ```
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**npm tag:** ${{ needs.version.outputs.npm_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry run:** ${{ needs.version.outputs.dry_run == 'true' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages:" >> $GITHUB_STEP_SUMMARY
          echo "- @ducklings/browser@${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- @ducklings/workers@${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package sizes:" >> $GITHUB_STEP_SUMMARY
          echo "- duckdb.wasm: $(du -h dist/duckdb.wasm | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- duckdb-workers.wasm: $(du -h dist/duckdb-workers.wasm | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.version.outputs.npm_tag }}" = "dev" ]; then
            echo "### Install dev version:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "npm install @ducklings/browser@dev" >> $GITHUB_STEP_SUMMARY
            echo "npm install @ducklings/workers@dev" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
